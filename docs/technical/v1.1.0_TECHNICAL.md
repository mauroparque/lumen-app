# Lumen Salud Mental — Documentación Técnica

**Versión:** 1.1.0  
**Fecha:** 2026-02-27  
**Versión anterior:** [v1.0.0_TECHNICAL.md](v1.0.0_TECHNICAL.md)  
**Changelog:** [CHANGELOG.md](../../CHANGELOG.md#110---2026-02-26)  
**Stack:** React 18 + TypeScript + Vite + Firebase + TailwindCSS

---

## Resumen de cambios respecto a v1.0.0

La v1.1.0 consolida 4 ciclos de mejora (Fases 1–4 post-auditoría) centrados en:

1. **Arquitectura de servicios** — migración completa de accesos directos a Firestore hacia `IDataService` (14 métodos nuevos)
2. **Bundle splitting** — chunk principal reducido de 693KB a 29.65KB
3. **Accesibilidad** — focus trap, ARIA y keyboard navigation en modales
4. **DX** — ESLint 9 flat config, Prettier, scripts de CI, coverage con thresholds
5. **Testing** — 92 tests unitarios en 6 archivos, coverage 80%+ en scope
6. **Estabilidad** — recálculo automático de ventana de datos, ErrorBoundary global, provider tree reestructurado

---

## Arquitectura General

```text
┌─────────────────────────────────────────────────────────────┐
│                         Frontend                            │
│  React 18 + TypeScript + Vite + TailwindCSS + PWA           │
│  ESLint 9 + Prettier + Vitest + Playwright                  │
├─────────────────────────────────────────────────────────────┤
│                         Backend                             │
│  Firebase (Auth + Firestore + Cloud Functions + Storage)    │
└─────────────────────────────────────────────────────────────┘
```

### Provider Tree (v1.1.0)

```text
LumenApp
  └─ AppErrorBoundary (react-error-boundary)
       └─ ServiceProvider (user, profile=null)
            └─ StaffGate
                 ├─ LoadingSpinner (mientras carga perfil)
                 ├─ ProfileModal (si no existe perfil)
                 └─ AuthenticatedApp (user, profile)
                      └─ ServiceProvider (user, profile)  ← re-wrap con perfil real
                           └─ DataProvider
                                └─ Sidebar + MobileHeader + vistas lazy-loaded
```

**Cambios respecto a v1.0.0:**

- Nuevo `AppErrorBoundary` envolviendo toda la app — previene crashes silenciosos por chunk-load failures
- Patrón `StaffGate` + `AuthenticatedApp` permite que `useStaff` acceda a `ServiceContext` antes de obtener el perfil
- `ServiceProvider` se instancia dos veces (sin y con perfil) para cubrir el flujo de onboarding

---

## Estructura del Proyecto

```bash
src/
├── App.tsx                           # Punto de entrada, StaffGate + AuthenticatedApp
├── main.tsx                          # Bootstrap de React
├── index.css                         # Estilos globales
├── types/index.ts                    # Interfaces TypeScript (+ BillingStatusData, TaskInput)
│
├── views/                            # Vistas principales (9, todas lazy-loaded)
│   ├── AuthScreen.tsx                # Login/Registro (con Cloudflare Turnstile)
│   ├── DashboardView.tsx             # Panel principal
│   ├── CalendarView.tsx              # Agenda/Calendario
│   ├── PatientsView.tsx              # Gestión de pacientes
│   ├── PatientHistoryView.tsx        # Historial clínico
│   ├── PaymentsView.tsx              # Pagos y proyección
│   ├── BillingView.tsx               # Facturación
│   ├── TasksView.tsx                 # Gestión de tareas
│   └── StatisticsView.tsx            # Estadísticas de agenda
│
├── components/
│   ├── ErrorBoundary.tsx             # [NUEVO] Fallback UI con react-error-boundary
│   ├── PWAUpdatePrompt.tsx           # Prompt de actualización PWA
│   ├── layout/                       # Sidebar, MobileHeader
│   ├── modals/                       # Modales
│   │   ├── AddTaskModal.tsx          # [MIGRADO] usa IDataService
│   │   ├── AppointmentDetailsModal.tsx # [FIX] previene doble-submit en notas
│   │   ├── AppointmentModal.tsx
│   │   ├── PatientModal.tsx
│   │   ├── PatientProfileModal.tsx
│   │   ├── PaymentModal.tsx
│   │   └── ProfileModal.tsx
│   ├── patients/                     # PatientTable, PatientCard
│   ├── payments/                     # IncomeProjection
│   └── ui/                           # LoadingSpinner, ModalOverlay [A11Y mejorado]
│
├── hooks/                            # Custom hooks
│   ├── useAgendaStats.ts             # Estadísticas de agenda
│   ├── useBillingStatus.ts           # [MIGRADO] usa IDataService
│   ├── useCalendarAppointments.ts    # Turnos para vista calendario
│   ├── useClinicalNotes.ts           # [REESCRITO] dos hooks: useClinicalNote + usePatientNotes
│   ├── useDataActions.ts             # [AMPLIADO] 18 acciones (+ updateTask, toggleSubtaskCompletion)
│   ├── usePatientData.ts             # [MIGRADO] usa IDataService
│   ├── usePatients.ts                # Lista de pacientes filtrada
│   ├── usePendingTasks.ts            # [MIGRADO] usa IDataService
│   ├── usePsiquePayments.ts          # [MIGRADO] usa IDataService
│   └── useStaff.ts                   # [MIGRADO] usa IDataService
│
├── context/
│   ├── DataContext.tsx               # [MEJORADO] recálculo ventana datos (4h + visibilitychange)
│   └── ServiceContext.tsx            # Firebase service injection (dual-mount)
│
├── services/
│   ├── IDataService.ts               # [AMPLIADO] 41 métodos (vs 18 en v1.0.0)
│   └── FirebaseService.ts            # Implementación Firestore (88% stmt coverage)
│
└── lib/
    ├── firebase.ts                   # Configuración Firebase
    ├── constants.ts                  # Constantes de dominio
    ├── psiqueCalculations.ts         # [NUEVO] cálculo puro Psique extraído
    ├── routes.ts                     # Rutas de colecciones Firestore
    └── utils.ts                      # cn() y utilidades
```

---

## Modelos de Datos

### Tipos auxiliares

```typescript
type View =
    | 'home'
    | 'dashboard'
    | 'calendar'
    | 'patients'
    | 'payments'
    | 'billing'
    | 'patient-history'
    | 'tasks'
    | 'statistics';

type ContactRelationship = 'padre' | 'madre' | 'amigo' | 'pareja' | 'otro';
```

### Patient

```typescript
interface Patient {
    id: string;
    name: string;
    firstName?: string;
    lastName?: string;
    dni?: string;
    email: string;
    phone: string;
    fee?: number;
    preference?: 'presencial' | 'online';
    office?: string;
    professional?: string;
    isActive: boolean;
    birthDate?: string; // YYYY-MM-DD
    admissionDate?: string; // YYYY-MM-DD
    dischargeType?: 'clinical' | 'dropout';
    dischargeDate?: string;
    patientSource?: 'psique' | 'particular';
    contactName?: string;
    contactPhone?: string;
    contactRelationship?: ContactRelationship;
    contactRelationshipOther?: string;
}
```

### Appointment

```typescript
interface Appointment {
    id: string;
    patientId: string;
    patientName: string;
    patientEmail?: string;
    date: string; // YYYY-MM-DD
    time: string; // HH:mm
    duration: number; // minutos
    type: 'presencial' | 'online';
    meetLink?: string;
    status: 'programado' | 'completado' | 'cancelado' | 'ausente' | 'presente';
    chargeOnCancellation?: boolean;
    isPaid?: boolean;
    price?: number;
    professional?: string;
    office?: string;
    hasNotes?: boolean;
    consultationType?: string;
    excludeFromPsique?: boolean;
    // Google Calendar
    googleEventId?: string;
    googleMeetLink?: string;
    // Recurrencia
    recurrenceId?: string;
    recurrenceIndex?: number;
    recurrenceRule?: string;
    // Facturación
    billingStatus?: 'pending' | 'requested' | 'invoiced';
    invoiceRequestId?: string;
}
```

### Payment

```typescript
interface Payment {
    id: string;
    appointmentId?: string;
    patientId?: string;
    patientName: string;
    amount: number;
    date: Timestamp | null;
    concept: string;
}
```

### ClinicalNote

```typescript
interface ClinicalNote {
    id: string;
    patientId: string;
    appointmentId: string;
    content: string;
    attachments: string[];
    tasks?: TaskItem[];
    createdAt: Timestamp;
    updatedAt?: Timestamp;
    createdBy: string;
    createdByUid: string; // UID del autor — reglas de acceso Firestore
}

interface TaskItem {
    text: string;
    completed: boolean;
    subtasks?: TaskSubitem[];
}

interface TaskSubitem {
    text: string;
    completed: boolean;
}
```

### TaskInput (nuevo en v1.1.0)

```typescript
interface TaskInput {
    patientId: string;
    professional: string;
    content: string;
    createdBy: string;
    createdByUid: string; // Corrige validación de ownership
    subtasks?: { text: string; completed: boolean }[];
}
```

### StaffProfile

```typescript
interface StaffProfile {
    uid: string;
    email: string;
    name: string;
    role: 'admin' | 'professional' | 'secretary';
    specialty?: string;
    color?: string;
    createdAt: Timestamp;
}
```

### BillingStatusData (nuevo en v1.1.0)

```typescript
type BillingRequestStatus = 'pending' | 'processing' | 'completed' | 'error' | 'error_sending' | 'error_config';

interface BillingStatusData {
    status: BillingRequestStatus;
    invoiceUrl?: string;
    invoiceNumber?: string;
    error?: string;
}

interface BillingLineItem {
    description: string;
    amount: number;
}
```

### PsiquePayment

```typescript
interface PsiquePayment {
    id: string;
    month: string; // YYYY-MM
    totalAmount: number;
    isPaid: boolean;
    paidDate?: string; // YYYY-MM-DD
}
```

### AllowedEmail

```typescript
interface AllowedEmail {
    email: string;
    role: 'admin' | 'professional';
    professionalName: string;
}
```

### Input types

```typescript
type PatientInput = Omit<Patient, 'id'>;
type AppointmentInput = Omit<Appointment, 'id'>;
type PaymentInput = Omit<Payment, 'id'>;
type ClinicalNoteInput = Omit<ClinicalNote, 'id'>;
```

---

## IDataService — Interface completa (v1.1.0)

41 métodos organizados en 8 grupos. Los métodos marcados con **[NUEVO]** fueron agregados en esta versión.

```typescript
interface IDataService {
    // ─── Suscripciones en tiempo real (4 existentes + 4 nuevas) ───
    subscribeToPatients(onData: (data: Patient[]) => void): () => void;
    subscribeToAppointments(start: string, end: string, onData: (data: Appointment[]) => void): () => void;
    subscribeToMyAppointments(start: string, end: string, onData: (data: Appointment[]) => void): () => void;
    subscribeToFinance(onUnpaid: (data: Appointment[]) => void, onPayments: (data: Payment[]) => void): () => void;

    // ─── Pacientes ───
    addPatient(patient: PatientInput): Promise<string>;
    updatePatient(id: string, data: Partial<Patient>): Promise<void>;
    deletePatient(id: string): Promise<void>;

    // ─── Turnos ───
    addAppointment(appointment: AppointmentInput): Promise<string>;
    addRecurringAppointments(
        baseAppointment: AppointmentInput,
        dates: string[],
        recurrenceRule?: string,
    ): Promise<void>;
    updateAppointment(id: string, data: Partial<Appointment>): Promise<void>;
    deleteAppointment(id: string): Promise<void>;
    deleteRecurringSeries(recurrenceId: string): Promise<number>;
    deleteRecurringFromDate(recurrenceId: string, fromDate: string): Promise<number>;

    // ─── Pagos ───
    addPayment(payment: PaymentInput, appointmentId?: string): Promise<string>;
    updatePayment(id: string, data: Partial<Payment>): Promise<void>;

    // ─── Facturación ───
    requestBatchInvoice(appointments: Appointment[], patientData: PatientBillingData): Promise<string>;
    subscribeToBillingStatus(requestId: string, onData: (status: BillingStatusData) => void): () => void; // [NUEVO]

    // ─── Notas Clínicas [NUEVO] ───
    subscribeToClinicalNote(appointmentId: string, onData: (note: ClinicalNote | null) => void): () => void;
    subscribeToPatientNotes(patientId: string, onData: (notes: ClinicalNote[]) => void): () => void;
    saveNote(noteData: Partial<ClinicalNote>, appointmentId: string, existingNoteId?: string): Promise<void>;
    updateNote(noteId: string, data: Partial<ClinicalNote>): Promise<void>;
    uploadNoteAttachment(file: File, patientId: string): Promise<string>;

    // ─── Tareas [NUEVO] ───
    subscribeToAllNotes(onData: (notes: ClinicalNote[]) => void): () => void;
    completeTask(noteId: string, taskIndex: number): Promise<void>;
    addTask(task: TaskInput): Promise<string>;
    updateTask(noteId: string, taskIndex: number, data: { text: string; subtasks?: TaskSubitem[] }): Promise<void>;
    toggleSubtaskCompletion(noteId: string, taskIndex: number, subtaskIndex: number): Promise<void>;

    // ─── Psique Payments [NUEVO] ───
    subscribeToPsiquePayments(
        professionalName: string | undefined,
        onData: (payments: Record<string, PsiquePayment>) => void,
    ): () => void;
    markPsiquePaymentAsPaid(docKey: string, data: Omit<PsiquePayment, 'id'> & { professional?: string }): Promise<void>;

    // ─── Patient-specific data [NUEVO] ───
    subscribeToPatientAppointments(patientId: string, onData: (appointments: Appointment[]) => void): () => void;
    subscribeToPatientPayments(patientId: string, onData: (payments: Payment[]) => void): () => void;

    // ─── Staff [NUEVO] ───
    subscribeToStaffProfile(uid: string, onData: (profile: StaffProfile | null) => void): () => void;
    createStaffProfile(uid: string, profile: StaffProfile): Promise<void>;
    updateStaffProfile(uid: string, data: Partial<StaffProfile>): Promise<void>;
}
```

---

## Hooks Principales

### `useDataActions` (ampliado)

CRUD centralizado con guard de disponibilidad del servicio. 18 acciones expuestas:

```typescript
const {
    addPatient,
    updatePatient,
    addAppointment,
    updateAppointment,
    addRecurringAppointments,
    addPayment,
    updatePayment,
    deleteItem, // pacientes, turnos
    deleteRecurringSeries,
    deleteRecurringFromDate,
    requestBatchInvoice,
    completeTask,
    addTask,
    updateTask, // [NUEVO]
    toggleSubtaskCompletion, // [NUEVO]
    updateNote,
    markPsiquePaymentAsPaid,
} = useDataActions();
```

### `useClinicalNotes` (reescrito)

Reemplaza el hook monolítico por dos hooks independientes — corrige violación de Rules of Hooks:

```typescript
// Nota clínica de un turno específico
const { note, loading, saveNote, uploadAttachment } = useClinicalNote(appointmentId);

// Todas las notas de un paciente
const { notes, loading } = usePatientNotes(patientId);
```

### `useBillingStatus` (migrado a IDataService)

Ya no importa `firebase/firestore` directamente:

```typescript
const { status, invoiceUrl, invoiceNumber, loading, error } = useBillingStatus(requestId);
```

### `useStaff` (migrado a IDataService)

Usa `service.subscribeToStaffProfile()`, `.createStaffProfile()`, `.updateStaffProfile()`:

```typescript
const { profile, loading, createProfile, updateProfile } = useStaff(user);
```

### `usePendingTasks` (migrado a IDataService)

Tracking real del estado de loading. Usa `service.subscribeToAllNotes()`:

```typescript
const { tasks, loading } = usePendingTasks();
```

### `usePsiquePayments` (migrado a IDataService)

Usa `service.subscribeToPsiquePayments()` y `service.markPsiquePaymentAsPaid()`.

### `usePatientData` (migrado a IDataService)

Usa `service.subscribeToPatientAppointments()` y `service.subscribeToPatientPayments()`.

### `useAgendaStats`

Sin cambios. Calcula estadísticas de los últimos 3 meses:

```typescript
const stats = useAgendaStats(appointments, patients);
```

### `useCalendarAppointments`

Sin cambios. Turnos del mes seleccionado para la vista calendario.

---

## Funcionalidades Principales

### 1. Gestión de Pacientes

- CRUD completo de pacientes
- Filtros: activo/inactivo, fuente (Psique/Particular)
- Historial clínico con notas y tareas

### 2. Agenda/Calendario

- Vista mensual con turnos
- Creación de turnos individuales y recurrentes
- Estados: programado, presente, ausente, cancelado, completado
- Integración Google Calendar (opcional)

### 3. Sistema de Pagos

- **Vencidos**: Turnos pasados sin pagar
- **Próximos**: Turnos futuros a cobrar
- **Historial**: Pagos realizados
- **Psique**: Gestión del 25% a pagar a Psique Salud Mental
- **Proyección**: Estimación de ingresos del próximo mes

### 4. Descuento Psique

- Pacientes con `patientSource: 'psique'` aplican 25% de comisión
- Cada turno puede excluirse individualmente (`excludeFromPsique`)
- Lógica de cálculo extraída a módulo puro `psiqueCalculations.ts`
- Se muestra bruto/neto en todos los listados

### 5. Estadísticas de Agenda

Calculadas sobre los últimos 3 meses:

- Promedio de sesiones por paciente
- Honorario promedio
- Valor real por sesión
- Tasa de ausentismo
- Tasa de cancelación
- Top 10 pacientes por sesiones

### 6. Facturación

- Generación de facturas vía webhook a n8n
- Suscripción real-time al estado via `subscribeToBillingStatus`
- Estados: `pending` → `processing` → `completed` | `error` | `error_sending` | `error_config`

### 7. Tareas Clínicas

- Tareas asociadas a pacientes (con `createdByUid` para ownership)
- Subtareas con checkbox (`toggleSubtaskCompletion`)
- Edición de tareas (`updateTask`)
- Vista global de tareas pendientes

---

## Mejoras de Performance (v1.1.0)

### Bundle Splitting

Configuración de `manualChunks` en `vite.config.ts`:

```typescript
manualChunks: {
  'vendor-react':    ['react', 'react-dom'],
  'vendor-firebase': ['firebase/app', 'firebase/auth', 'firebase/firestore',
                      'firebase/storage', 'firebase/functions'],
  'vendor-ui':       ['lucide-react', 'sonner'],
}
```

**Resultado:** Chunk principal reducido de **693KB → 29.65KB**. Los vendors se cachean por separado en el Service Worker.

### Recálculo automático de ventana de datos

`DataContext` ahora recalcula la ventana de fechas (3 meses atrás → 6 meses adelante) ante:

- **`visibilitychange`** — cuando el usuario vuelve a la pestaña
- **Intervalo de 4 horas** — previene stale data en sesiones largas de PWA

---

## Accesibilidad (v1.1.0)

### ModalOverlay

- `role="dialog"` + `aria-modal="true"` + `aria-label` configurable
- **Focus trap**: Tab/Shift+Tab cicla dentro del modal
- **Escape** cierra el modal
- **Restauración de foco**: guarda `document.activeElement` al montar, restaura al desmontar
- Auto-focus al primer elemento focusable al abrir

---

## Cálculos Psique — Módulo puro (v1.1.0)

Extraído a `src/lib/psiqueCalculations.ts` (sin dependencias de React):

```typescript
const PSIQUE_RATE = 0.25;

interface PsiquePatientBreakdown {
    /* ... */
}
interface PsiqueMonthData {
    /* ... */
}

function getDocKey(month: string, professional?: string): string;
function calculatePsiqueMonthData(
    appointments: Appointment[],
    psiquePatientIds: Set<string>,
    selectedMonth: Date,
    psiquePayments: Record<string, PsiquePayment>,
    professionalName?: string,
): PsiqueMonthData;
```

---

## ErrorBoundary (v1.1.0)

Componente global basado en `react-error-boundary`:

- Fallback UI en español con detalles del error (solo en DEV)
- Dos acciones: "Reintentar" (reset del boundary) + "Recargar página" (full reload)
- Envuelve `Suspense` en `App.tsx` — captura errores de chunk-load

---

## Colecciones Firestore

Todas bajo `artifacts/{appId}/clinics/{CLINIC_ID}/`:

| Colección                         | Descripción                                     |
| --------------------------------- | ----------------------------------------------- |
| `patients`                        | Pacientes de la clínica                         |
| `appointments`                    | Turnos (filtrados por profesional en queries)   |
| `payments`                        | Pagos registrados                               |
| `staff`                           | Perfiles del equipo (auth + roles)              |
| `allowedEmails`                   | Lista blanca para onboarding                    |
| `notes`                           | Notas clínicas por turno                        |
| `psiquePayments`                  | Registros mensuales de pago a Psique            |
| `integrations/billing/queue/{id}` | Cola de solicitudes de facturación (write-once) |

---

## Seguridad (Firestore Rules)

Sin cambios respecto a v1.0.0. RBAC con roles `admin` / `professional` / `secretary`.

Reglas clave:

- **Staff**: admin CRUD; profesional crea y lee el propio
- **Pacientes**: admin CRUD; profesional CRUD propios + lectura global
- **Turnos**: protección de facturados — solo `isPaid` editable si `billingStatus == 'invoiced'`
- **Pagos**: delete bloqueado (`allow delete: if false`)
- **Notas clínicas**: solo creador o admin; `createdByUid` y `createdBy` inmutables
- **Billing queue**: write-once (no update/delete)

---

## DX — Developer Experience (v1.1.0)

### ESLint 9 Flat Config

```javascript
// eslint.config.js — ESLint 9 flat config format
// Stack: @eslint/js recommended → @typescript-eslint → react-hooks → react-refresh → prettier
// Rules: no-explicit-any: warn, no-unused-vars con argsIgnorePattern: '^_'
// Ignores: dist/, node_modules/, functions/, scripts/, *.config.*
```

### Prettier

`.prettierrc` con:

- `singleQuote: true`
- `tabWidth: 4`
- `printWidth: 100`

### Scripts npm

```bash
npm run dev           # Vite dev server (localhost:5173)
npm run build         # Build producción
npm run preview       # Preview del build
npm test              # Unit tests (Vitest)
npm run test:ui       # Vitest con UI interactiva
npm run test:coverage # Vitest con coverage report
npm run test:e2e      # Playwright E2E tests
npm run lint          # ESLint check                    [NUEVO]
npm run lint:fix      # ESLint auto-fix                 [NUEVO]
npm run format        # Prettier write                  [NUEVO]
npm run format:check  # Prettier check                  [NUEVO]
npm run type-check    # tsc --noEmit                    [NUEVO]
npm run ci            # type-check + lint + test + build [NUEVO]
```

### Firebase

```bash
firebase deploy --only firestore:rules
firebase deploy --only hosting
```

---

## Testing (v1.1.0)

### Unit Tests (Vitest)

- **Framework**: Vitest + jsdom + `@testing-library/react`
- **Setup**: `src/test/setup.ts` con `restoreMocks: true`
- **Total**: 92 tests en 6 archivos
- **Coverage provider**: `@vitest/coverage-v8`

#### Coverage scope y thresholds

| Archivo                           | Scope     |
| --------------------------------- | --------- |
| `src/lib/utils.ts`                | ✓         |
| `src/lib/psiqueCalculations.ts`   | ✓ [NUEVO] |
| `src/hooks/useAgendaStats.ts`     | ✓         |
| `src/hooks/usePendingTasks.ts`    | ✓ [NUEVO] |
| `src/services/FirebaseService.ts` | ✓ [NUEVO] |

| Métrica    | Threshold |
| ---------- | --------- |
| Lines      | 80%       |
| Functions  | 80%       |
| Statements | 80%       |
| Branches   | 60%       |

#### Archivos de test

| Test                                             | Tests | Descripción                       |
| ------------------------------------------------ | ----- | --------------------------------- |
| `src/lib/__tests__/utils.test.ts`                | —     | Utilidades generales              |
| `src/lib/__tests__/psiqueCalculations.test.ts`   | —     | Cálculos Psique puros             |
| `src/hooks/__tests__/useAgendaStats.test.ts`     | 6     | Estadísticas de agenda            |
| `src/hooks/__tests__/usePendingTasks.test.ts`    | 8     | Tareas pendientes                 |
| `src/services/__tests__/IDataService.test.ts`    | —     | Mock factory + completeness       |
| `src/services/__tests__/FirebaseService.test.ts` | 50    | Operaciones Firestore (88% stmts) |

### E2E Tests (Playwright)

- **Ubicación**: `tests/*.spec.ts`
- **Browser**: Chromium
- **Base URL**: `http://localhost:5173`

---

## PWA

Configurado con `vite-plugin-pwa`:

- Service Worker con Workbox
- `registerType: 'prompt'` — actualización manual con prompt
- `cacheId` dinámico para cache-busting del SW
- Caching de Google Fonts
- Precaching de assets con `manualChunks` splitting

---

## Dependencias Principales

| Paquete                   | Versión         | Uso                                |
| ------------------------- | --------------- | ---------------------------------- |
| react                     | 18.2.0          | UI Framework                       |
| firebase                  | ^10.8.0         | Backend (Auth, Firestore, Storage) |
| lucide-react              | ^0.344.0        | Íconos                             |
| tailwindcss               | ^3.4.19         | Estilos                            |
| sonner                    | ^2.0.7          | Notificaciones toast               |
| vite-plugin-pwa           | ^1.2.0          | PWA support                        |
| react-error-boundary      | —               | ErrorBoundary global [NUEVO]       |
| @marsidev/react-turnstile | ^1.4.0          | Cloudflare Turnstile (anti-bot)    |
| clsx + tailwind-merge     | ^2.1.1 / ^3.4.0 | Utility `cn()`                     |

### DevDependencies relevantes

| Paquete                | Versión | Uso                                   |
| ---------------------- | ------- | ------------------------------------- |
| vitest                 | ^4.0.16 | Unit testing                          |
| @vitest/coverage-v8    | —       | Coverage con thresholds [NUEVO]       |
| @playwright/test       | ^1.57.0 | E2E testing                           |
| @testing-library/react | ^16.3.1 | Component testing                     |
| jsdom                  | ^27.4.0 | Entorno DOM para Vitest               |
| eslint                 | ^9.x    | Linting (flat config) [NUEVO]         |
| @eslint/js             | ^9.x    | ESLint base recommended [NUEVO]       |
| @typescript-eslint/\*  | —       | TypeScript ESLint [NUEVO]             |
| eslint-config-prettier | —       | Desactiva reglas conflictivas [NUEVO] |
| prettier               | —       | Formateo de código [NUEVO]            |

---

## Migraciones completadas en v1.1.0

### Acceso directo a Firestore → IDataService

| Hook / Componente   | Antes (v1.0.0)                | Después (v1.1.0)                                          |
| ------------------- | ----------------------------- | --------------------------------------------------------- |
| `useBillingStatus`  | `firebase/firestore` directo  | `service.subscribeToBillingStatus()`                      |
| `useStaff`          | `firebase/firestore` directo  | `service.subscribeToStaffProfile()` + `create` + `update` |
| `useClinicalNotes`  | Hook monolítico con Firestore | Dos hooks vía `IDataService`                              |
| `usePendingTasks`   | `firebase/firestore` directo  | `service.subscribeToAllNotes()`                           |
| `usePsiquePayments` | `firebase/firestore` directo  | `service.subscribeToPsiquePayments()`                     |
| `usePatientData`    | `firebase/firestore` directo  | `service.subscribeToPatient{Appointments,Payments}()`     |
| `AddTaskModal`      | Firestore directo             | `useDataActions().addTask()`                              |
| `TasksView`         | 17 líneas de handler          | 5 líneas vía `useDataActions()`                           |

**Resultado:** 0 imports directos de `firebase/firestore` fuera de `FirebaseService.ts` y `firebase.ts`.
